@model IEnumerable<NIA_CRM.ViewModels.DashboardDetailsViewModel>

@{
    ViewData["Title"] = "Index";
}

<!--WIDGETS-->
<div class="content" id="content">
    <h1>Dashboard</h1>
    <div class="row">
        <!-- Card 1 -->
        <div class="col-md-4">
            <div class="card">
                <div class="card-body text-center">
                    <p class="card-title">Total Members</p>
                    <p class="card-text">@Model.Count()</p>
                </div>
            </div>
        </div>
        <!-- Card 2 -->
        <div class="col-md-4">
            <div class="card">
                <div class="card-body text-center">
                    <p class="card-title">Members in Copperport</p>
                    <p class="card-text">@Model.Count(m => m.Address.City == "Copperport")</p>
                </div>
            </div>
        </div>
        <!-- Card 3 -->
        <div class="col-md-4">
            <div class="card">
                <div class="card-body text-center">
                    <p class="card-title">VIP Clients</p>
                    <p class="card-text">@ViewData["VipCount"]</p>
                </div>
            </div>
        </div>
    </div>
</div>


<!--Member Table-->

<h2>Member Details</h2>
<form asp-action="Index" method="get">

    <div class="table-container">

        <!-- Filter/Search Button -->
        <input type="hidden" name="sortDirection" value="@ViewData["sortDirection"]" />
        <input type="hidden" name="sortField" value="@ViewData["sortField"]" />

        <div class="form-horizontal mb-3">
            <button class="btn btn-secondary @ViewData["Filtering"]" type="button" data-bs-toggle="collapse" id="filterToggle"
                    data-bs-target="#collapseFilter" aria-expanded="false" aria-controls="collapseFilter">
                Filter/Search @ViewData["numberFilters"]
            </button>
            <div class="collapse @ViewData["ShowFilter"] mt-2" id="collapseFilter">
                <div class="card card-body bg-light">
                    <div class="row">
                        <div class="form-group col-md-4">
                            <label for="SearchString" class="control-label">Search By Member Name:</label>
                            @Html.TextBox("SearchString", null, new { @class = "form-control", placeholder = "Enter subject..." })
                        </div>
                        <div class="form-group col-md-4">
                            <label for="EmailTypeID" class="control-label">Filter by Organization:</label>
                            @Html.DropDownList("OrganizationID", null, "All Organizations", htmlAttributes: new { @class = "form-control" })
                        </div>
                        <div class="form-group col-md-4">
                            <label for="EmailTypeID" class="control-label">Filter by Industry:</label>
                            @Html.DropDownList("IndustryID", null, "All Industry", htmlAttributes: new { @class = "form-control" })
                        </div>
                        
                        <div class="form-group col-md-4 d-flex align-items-end mt-2">
                            <input type="submit" name="actionButton" value="Apply Filters" class="btn btn-primary me-2" />
                            <a asp-action="Index" class="btn btn-dark">Clear Filters</a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <!--Table Data-->
    <div class="table-container mt-4" style="position: relative; overflow: auto; border: 1px solid #ddd;">
        <table class="table table-bordered table-striped" style="table-layout: fixed; width: 100%;" id="myTable">
            <thead class="thead-dark">
                <tr>
                    <th style="position: sticky; top: 0; left: 0; z-index: 1030; background: #434343; color: #fff; width: 200px;">
                        <input type="submit" name="actionButton" value="Member Name" class="btn btn-link" />

                    </th>
                    <th style="position: sticky; top: 0; z-index: 1020; background: #434343; color: #fff; width: 150px;">
                        <input type="submit" name="actionButton" value="Organization" class="btn btn-link" />

                    </th>
                    <th style="position: sticky; top: 0; z-index: 1020; background: #434343; color: #fff; width: 150px;">
                        <input type="submit" name="actionButton" value="Industry" class="btn btn-link" />

                    </th>
                    <th style="position: sticky; top: 0; z-index: 1020; background: #434343; color: #fff; width: 300px;">Address</th>
                    <th style="position: sticky; top: 0; z-index: 1020; background: #434343; color: #fff; width: 200px;">Contact Name</th>
                    <th style="position: sticky; top: 0; z-index: 1020; background: #434343; color: #fff; width: 200px;">Contact Title</th>
                    <th style="position: sticky; top: 0; z-index: 1020; background: #434343; color: #fff; width: 200px;">Contact Department</th>
                    <th style="position: sticky; top: 0; z-index: 1020; background: #434343; color: #fff; width: 250px;">Contact Email</th>
                    <th style="position: sticky; top: 0; z-index: 1020; background: #434343; color: #fff; width: 200px;">Contact Phone</th>
                    <th style="position: sticky; top: 0; z-index: 1020; background: #434343; color: #fff; width: 150px;">LinkedIn</th>
                    <th style="position: sticky; top: 0; z-index: 1020; background: #434343; color: #fff; width: 100px;">VIP Status</th>
                    <th style="position: sticky; top: 0; z-index: 1020; background: #434343; color: #fff; width: 100px;">Pin Column</th>
                </tr>
            </thead>
            <tbody>
                @foreach (var member in Model)
                {

                    <tr class="clickable-row" data-id="@member.ID">
                        <td style="position: sticky; left: 0; z-index: 1020; background: #f8f9fa;">@member.MemberFirstName</td>
                        <td>@member.OrganizationName</td>
                        <td>@member.IndustryName</td>
                        <td>
                            <div style="white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">
                                @member.Address.AddressLineOne
                                @if (!string.IsNullOrEmpty(member.Address.AddressLineTwo))
                                {
                                    @member.Address.AddressLineTwo
                                }
                                <br />@member.Address.City, @member.Address.StateProvince, @member.Address.PostalCode
                                <br />@member.Address.Country
                            </div>
                        </td>
                        @if (member.Contacts != null && member.Contacts.Count > 0)
                        {
                            <td colspan="7">
                                <table class="table">
                                    @foreach (var contact in member.Contacts) // Corrected the loop variable name
                                    {
                                        <tr>
                                            <td style="width: 200px;">@contact.ContactFirstName</td> <!-- Corrected property name -->
                                            <td style="width: 200px;">@contact.Title</td>
                                            <td style="width: 200px;">@contact.Department</td>
                                            <td style="word-wrap: break-word; overflow-wrap: break-word; width: 250px;">@contact.EMail</td>
                                            <td style="white-space: nowrap; width: 200px;">@contact.Phone</td>
                                            <td style="width: 150px;">
                                                @if (!string.IsNullOrEmpty(contact.LinkedinUrl))
                                                {
                                                    <a href="@contact.LinkedinUrl" target="_blank">LinkedIn</a>
                                                }
                                            </td>
                                            <td style="width: 100px;">@(contact.IsVIP ? "Yes" : "No")</td>
                                        </tr>
                                    }
                                </table>
                            </td>
                        }
                        else
                        {
                            <td colspan="7">No Contacts Available</td>
                        }

                        <td>
                            <button class="btn btn-primary btn-sm pin-column" onclick="pinColumn(this)">Pin</button>
                        </td>

                    </tr>
                }
            </tbody>
        </table>
        <div id="previewContainer" class="preview-content hidden"></div>

    </div>
    <partial name="_PagingNavBar" />

</form>

@section Scripts {
    <style>
        /* Highlight row on hover */
        .clickable-row:hover {
            background-color: #f5f5f5; /* Light grey background */
            cursor: pointer; /* Hand cursor */
        }

        .hidden {
            visibility: hidden; /* Prevent visibility on page load */
            transform: translateX(100%);
            transition: transform 0.5s ease-in-out, visibility 0s 0.5s; /* Delay visibility change */
        }

        .visible {
            visibility: visible; /* Ensure it's visible when sliding in */
            transform: translateX(0);
            transition: transform 0.5s ease-in-out, visibility 0s 0s; /* Remove the delay for visibility */
        }

        .preview-content {
            position: fixed;
            top: 0;
            right: 0;
            width: 25%;
            height: 100vh;
            background-color: #f8f9fa;
            padding: 20px;
            box-shadow: -5px 0 10px rgba(0, 0, 0, 0.2);
            overflow-y: auto;
        }

        .d-flex.flex-row {
            overflow: hidden;
        }
    </style>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

    <script>
        $(document).ready(function () {
            // Initially hide the preview container
            $('#previewContainer').addClass('hidden');

            // Handle row clicks
            $(document).on('click', '.clickable-row', function () {
                var memberId = $(this).data('id'); // Get the Member ID
                if (!memberId) {
                console.error('No member ID found.');
                    return;
                }

                // AJAX request to fetch member details
                $.ajax({
                    url: '/Home/GetMemberPreview', // Adjust the route as necessary
                    type: 'GET',
                    data: { id: memberId },
                    success: function (result) {
                        $('#previewContainer').html(result).removeClass('hidden').addClass('visible');
                    },
                    error: function () {
                        alert('Error fetching member details.');
                    }
                });
            });

            // Hide the preview container when clicking outside
            $(window).click(function (event) {
                if (!$(event.target).closest('#previewContainer, .clickable-row').length) {
                    $('#previewContainer').removeClass('visible').addClass('hidden');
                }
            });

            // Prevent clicks inside the preview container from propagating
            $('#previewContainer').click( function (event) {
                event.stopPropagation();
            });
        });
    </script>

    <script type="text/javascript">
        var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'))
        var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
            return new bootstrap.Tooltip(tooltipTriggerEl)
        })
    </script>
}
