@model NIA_CRM.Models.Member

@{
    ViewData["Title"] = "Details";
}
<partial name="_Notification" />
<partial name="_addArchiveModal" />


<div class="row align-items-center">
    <!-- Logo (Member Thumbnail or Default Image) -->
    <div class="col-auto">
        @if (Model.MemberLogo?.Content != null)
        {
            string imageBase64 = Convert.ToBase64String(Model.MemberLogo.Content);
            string imageSrc = $"data:{Model.MemberLogo.MimeType};base64,{imageBase64}";
            <img src="@imageSrc" alt="Profile Picture of @Model.MemberName"
                 title="Profile Picture of @Model.MemberName"
                 class="img-fluid rounded" style="height: 70px; width: 70px; object-fit: cover;" />
        }
        else
        {
            <img src="~/images/Unknown_person.jpg"
                 alt="Profile Picture of @Model.MemberName"
                 title="Profile Picture of @Model.MemberName"
                 class="img-fluid rounded" style="height: 70px; width: 70px; object-fit: cover;" />
        }
    </div>

    <!-- Member Name -->
    <div class="col">
        <h1 class="mb-0">@Model.MemberName</h1>
    </div>
</div>

<div>
    <h4>Details</h4>
    <hr />
    @{
        var contacts = Model.MemberContacts?.Select(mc => mc.Contact).ToList();
        var primaryContact = contacts?.FirstOrDefault(c => c.IsVip) ?? contacts?.FirstOrDefault();
        var additionalContacts = contacts?.Where(c => c != primaryContact).ToList();
        var addres = Model?.Address;
    }

    <div class="container">
        <div class="row">
            <!-- Left Card: Detailed Information -->
            <div class="col-md-6">
                <h5 class="card-title">Detailed Information</h5>
                <div class="card card-body bg-light text-black">
                    <div class="row">
                        <!-- Left Column: Address & Membership Type -->
                        <div class="col-md-6">
                            <dl>
                                <dt>Address:</dt>
                                <dd>
                                    @if (Model.Address != null)
                                    {
                                        <p>
                                            @Model.Address.AddressLine1<br />
                                            @if (!string.IsNullOrEmpty(Model.Address.AddressLine2))
                                            {
                                                @Model.Address.AddressLine2
                                                <br />
                                            }
                                            @Model.Address.City, @Model.Address.StateProvince, @Model.Address.PostalCode<br />
                                        </p>

                                    }
                                    else
                                    {
                                        <p>No addresses available.</p>
                                    }
                                </dd>

                                <dt>Membership Type:</dt>
                                <dd>
                                    @{
                                        int membershipCount = Model.MemberMembershipTypes.Count;
                                        if (membershipCount > 0)
                                        {
                                            string firstMembershipType = Model.MemberMembershipTypes.FirstOrDefault().MembershipType.TypeName;
                                            if (membershipCount > 1)
                                            {
                                                string membershipList = ""; // HTML string of membership type names separated by <br /> tags
                                                var memberships = Model.MemberMembershipTypes.ToList();
                                                for (int i = 1; i < membershipCount; i++) // Skip the first because we have it already
                                                {
                                                    membershipList += memberships[i].MembershipType.TypeName + " <br />";
                                                }
                                                <a class="role='button'" data-bs-toggle="collapse" href="#collapseMembership@(Model.ID)"
                                                   aria-expanded="false" aria-controls="collapseMembership@(Model.ID)">
                                                    @firstMembershipType <span class="badge bg-info">@membershipCount</span>
                                                </a>
                                                <div class="collapse" id="collapseMembership@(Model.ID)">
                                                    @Html.Raw(membershipList)
                                                </div>
                                            }
                                            else
                                            {
                                                @firstMembershipType
                                            }

                                        }
                                        else
                                        {
                                            <p>No membership type available.</p>
                                        }
                                    }
                                    
                                </dd>

                                <dt>Tag:</dt>
                                <dd>
                                    @if (Model.MemberTags != null && Model.MemberTags.Any())
                                    {
                                        @foreach (var tag in Model.MemberTags)
                                        {
                                            <p>@tag.MTag.MTagName</p>
                                        }
                                    }
                                    else
                                    {
                                        <p>No tag available.</p>
                                    }
                                </dd>
                                <dt>Sector:</dt>
                                <dd>
                                    @if (Model.MemberSectors != null && Model.MemberSectors.Any())
                                    {
                                        @foreach (var sector in Model.MemberSectors)
                                        {
                                            <p>@sector.Sector.SectorName</p>
                                        }
                                    }
                                    else
                                    {
                                        <p>No sector available.</p>
                                    }
                                </dd>
                            </dl>
                        </div>

                        <!-- Right Column: Other Details -->
                        <div class="col-md-6">

                            <dt>NAICS Code:</dt>
                            <dd>
                                @if (Model.IndustryNAICSCodes != null && Model.IndustryNAICSCodes.Any())
                                {
                                    @foreach (var NAIC in Model.IndustryNAICSCodes)
                                    {
                                        <p>@NAIC.NAICSCode.Code - @NAIC.NAICSCode.Description</p>
                                    }
                                }
                                else
                                {
                                    <p>No NAICS Code available.</p>
                                }
                            </dd>
                            <dl>
                                <dt>@Html.DisplayNameFor(model => model.JoinDate)</dt>
                                <dd>@Html.DisplayFor(model => model.JoinDate)</dd>

                                <dt>Website:</dt>
                                <dd>
                                    <a href="@Model.WebsiteUrl" target="_blank">
                                        @Html.DisplayFor(model => model.WebsiteUrl)
                                    </a>
                                </dd>

                                <dt>Size:</dt>
                                <dd>@Html.DisplayFor(model => model.MemberSize)</dd>
                            </dl>
                        </div>
                    </div>
                    <div class="position-bottom-left">
                        @if (User.IsInRole("Admin"))
                        {
                            <a class="btn btn-secondary me-2" asp-controller="Member" asp-action="Edit" asp-route-id="@Model.ID">Edit General Info</a>
                            <a class="btn btn-secondary me-2" asp-controller="Address" asp-action="Edit" asp-route-id="@addres.Id" asp-route-memberid="@addres.MemberId" asp-route-membername="@addres.Member.MemberName">Edit Address</a>
                        }
                    </div>
                </div>
            </div>


            <!-- Right Card: Primary Contact Information -->
            <div class="col-md-6">
                <h5>Primary Contact Information</h5>
                @if (primaryContact != null)
                {
                    <div class="card card-body bg-light text-black">
                        <div class="row">
                            <!-- Left Column -->
                            <div class="col-md-6">
                                <dl>
                                    <dt>Contact Name:</dt>
                                    <dd>
                                        @primaryContact.Summary
                                        @if (primaryContact.IsVip)
                                        {
                                            <span class="badge bg-warning text-dark ms-2">VIP</span>
                                        }
                                    </dd>

                                    <dt>Title:</dt>
                                    <dd>@primaryContact.Title</dd>

                                    <dt>Department:</dt>
                                    <dd>@primaryContact.Department</dd>
                                </dl>
                            </div>

                            <!-- Right Column -->
                            <div class="col-md-6">
                                <dl>
                                    <dt>Email:</dt>
                                    <dd><a href="mailto:@primaryContact.Email">@primaryContact.Email</a></dd>

                                    <dt>Phone:</dt>
                                    <dd><a href="tel:@primaryContact.PhoneFormatted" id="phoneNumber">@primaryContact.PhoneFormatted</a></dd>

                                    @if (!string.IsNullOrEmpty(primaryContact.LinkedInUrl))
                                    {
                                        <dt>LinkedIn:</dt>
                                        <dd><a href="@primaryContact.LinkedInUrl" target="_blank">@primaryContact.LinkedInUrl</a></dd>
                                    }



                                </dl>
                            </div>
                        </div>
                        <div class="position-bottom-left">
                            @if (User.IsInRole("Admin"))
                            {
                                <button type="button" class="btn btn-light me-2"
                                        data-bs-toggle="modal"
                                        data-bs-target="#addCancellationModal"
                                        data-id="@primaryContact.Id">
                                    Archive Contact
                                </button>
                                <a class="btn btn-secondary" asp-controller="Contact" asp-action="Edit" asp-route-id="@primaryContact.Id">Edit</a>
                            }
                        </div>
                    </div>
                }
                else
                {
                    <p>No primary contact available.</p>
                }
            </div>

            <!-- Additional Contacts (If any) -->
            @if (additionalContacts != null && additionalContacts.Any())
            {
                <div class="row mt-3">
                    <div class="col-md-12">
                        <h5>Additional Contacts</h5>
                        @foreach (var contact in additionalContacts)
                        {
                            <div class="mb-3">
                                <div class="card card-body bg-white text-black">
                                    <dl class="row">
                                        <div class="col-sm-4">
                                            <dt>Contact Name:</dt>
                                            <dd>@contact.Summary</dd>
                                        </div>
                                        <div class="col-sm-4">
                                            <dt>Title:</dt>
                                            <dd>@contact.Title</dd>
                                        </div>
                                        <div class="col-sm-4">
                                            <dt>Department:</dt>
                                            <dd>@contact.Department</dd>
                                        </div>
                                        <div class="col-sm-4">
                                            <dt>Email:</dt>
                                            <dd><a href="mailto:@contact.Email">@contact.Email</a></dd>
                                        </div>
                                        <div class="col-sm-4">
                                            <dt>Phone:</dt>
                                            <dd><a href="tel:@contact.PhoneFormatted" id="phoneNumber">@contact.PhoneFormatted</a></dd>
                                        </div>
                                        @if (!string.IsNullOrEmpty(contact.LinkedInUrl))
                                        {
                                            <div class="col-sm-4">
                                                <dt>LinkedIn:</dt>
                                                <dd><a href="@contact.LinkedInUrl" target="_blank">@contact.LinkedInUrl</a></dd>
                                            </div>
                                        }
                                    </dl>
                                    <div class="position-bottom-left">
                                        @if (User.IsInRole("Admin"))
                                        {
                                            <button type="button" class="btn btn-light me-2"
                                                    data-bs-toggle="modal"
                                                    data-bs-target="#addCancellationModal"
                                                    data-id="@contact.Id">
                                                Archive Contact
                                            </button>
                                            <a class="btn btn-secondary" asp-controller="Contact" asp-action="Edit" asp-route-id="@contact.Id">Edit</a>
                                        }
                                    </div>
                                </div>
                            </div>
                        }
                    </div>
                </div>
            }

            <!-- Additional Information Card (How Long Since Joined, Days Left, Notes) -->
            <div class="row mt-3">
                <div class="col-md-12">
                    <h5>Additional Information</h5>
                    <div class="card card-body bg-light text-black">

                        <div class="row">
                            <div class="col-md-4">
                                <dt>How Long Since Joined:</dt>
                                <dd>@Html.DisplayFor(model => model.TimeSinceJoined)</dd>
                            </div>
                            <div class="col-md-4">
                                <dt>Days Left in Subscription:</dt>
                                <dd>3 months 4 days</dd>
                            </div>
                            <div class="col-md-4">
                                <dt>Notes:</dt>
                                <dd>@Html.DisplayFor(model => model.MemberNote)</dd>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

        </div>

        <div class="position-bottom-left">
            @if (User.IsInRole("Admin"))
            {
                <a class="btn btn-dark me-2" data-bs-toggle="modal" data-bs-target="#addCancellationModal" data-id="@Model.ID">Archive</a>
                <a class="btn btn-primary me-2" asp-controller="Contact" asp-action="Create" asp-route-memberId="@Model.ID" asp-route-memberName="@Model.MemberName">Create New Contact</a>
                <a class="btn btn-primary me-2" asp-controller="Member" asp-action="Edit" asp-route-id="@Model.ID">Edit</a>
            }
            <a class="btn btn-primary me-2" asp-controller="Member" asp-action="Index">Back to Members</a>
        </div>
    </div>
</div>
@section Scripts {
    <script type="text/javascript">
        document.addEventListener("DOMContentLoaded", function () {
            var modal = document.getElementById('addCancellationModal'); // Fixed modal ID

            // When the modal is about to be shown
            modal.addEventListener('show.bs.modal', function (event) {
                var button = event.relatedTarget;  // Button that triggered the modal
                var memberId = button.getAttribute('data-id');  // Get Member ID from button

                console.log("Member ID received:", memberId); // Debugging log

                // Set the Member ID in the hidden input field inside the modal
                //document.getElementById('MemberID').value = memberId;

                // Make AJAX GET request to fetch member data and fill the form dynamically
                $.ajax({
                    type: "GET",
                    url: '/Cancellation/Create',  // Ensure this points to the correct action URL
                    data: { memberId: memberId },
                    success: function (response) {
                        console.log(response.memberName);
                        if (response.success) {
                            // Populate the form with the received data
                            $('#createCancellationForm').find('input[name="MemberID"]').val(response.memberId);
                           // $('#MemberID').val(response.memberId);  // Set MemberID in the form field
                            $('#MemberName').text(response.memberName);  // Optionally display MemberName in the modal header or form
                        } else {
                            console.error("Failed to fetch member data:", response.message);
                        }
                    },
                    error: function (xhr) {
                        console.error("Error fetching member data:", xhr);
                    }
                });
            });

            // Handle form submission with AJAX
                    $('#submitCancellationCreate').click(function (event) {
            event.preventDefault();  // Prevent default form submission
            clearErrors();  // Clear previous error messages

            var form = $('#createCancellationForm'); // Fixed form ID
            var memberId = $('#MemberID').val(); // Get Member ID from hidden input field
            memberId = parseInt(memberId);
            console.log("Submitting form for Member ID:", memberId); // Debugging log

            // Validate the form
            if (form.valid()) {
                $.ajax({
                    type: "POST",
                    url: form.attr('action'),  // The form's action URL
                    data: form.serialize() + "&MemberID=" + memberId, // Ensure MemberID is included
                    success: function (response) {
                        if (response.success) {
                            $('#addCancellationModal').modal('hide');
                            //alert(response.message); // Optionally show success message
                            location.reload(); // Refresh page to reflect changes
                        } else {
                            console.error("Error: " + response.message);
                            showErrorMessage(response.message); // Show error messages
                        }
                    },
                    error: function (xhr) {
                        console.error("Error: ", xhr);
                        showErrorMessage("An unexpected error occurred."); // General error message
                    }
                });
            }

            return false; // Prevent default form submission
        });

        // Function to show error messages in the modal
        function showErrorMessage(message) {
            var ul = document.getElementById("ErrorList");
            ul.innerHTML = "";  // Clear previous errors

            // Split and display each error message
            var errors = message.split("|");
            errors.forEach(function (error) {
                var li = document.createElement("li");
                li.innerHTML = error;
                ul.appendChild(li);
            });
        }

            // Function to handle error messages from AJAX response
            function handleAjaxErrors(xhr) {
                var errorMessages = [];
                switch (xhr.status) {
                    case 401:
                        errorMessages.push("You must be logged in first.");
                        break;
                    case 403:
                        errorMessages.push("You are not authorized for this action.");
                        break;
                    default:
                        errorMessages = xhr.responseText.split("|").slice(0, -1);
                }

                if (!errorMessages.some((str) => str !== "")) {
                    errorMessages.push("Error: Unable to complete operation");
                }


            }

            // Function to clear previous error messages
            function clearErrors() {
                var ul = document.getElementById("ErrorList");
                ul.innerHTML = "";  // Clear previous error messages
            }
        });
    </script>

    }
